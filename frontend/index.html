<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Live Threat Map</title>
    <style>
      html, body {
        margin:0; height:100%; background:#000; color:#eee;
        font-family:system-ui; overflow:hidden;
      }
      #globe { position:fixed; inset:0; }
      #hud {
        position:fixed; left:12px; top:12px;
        background:rgba(0,0,0,.6);
        padding:10px 14px; border-radius:10px;
        box-shadow:0 0 12px rgba(0,255,0,0.25);
        font-size:20px; /* bigger font */
      }
      .dot {
        display:inline-block; width:12px; height:12px;
        border-radius:50%; margin-right:6px;
        background:#000; /* default disconnected */
        border:1px solid #333;
      }
      #tooltip {
        position: fixed;
        background: rgba(0,0,0,0.75);
        color: #fff;
        padding: 6px 8px;
        border-radius: 6px;
        pointer-events: none;
        font-size: 13px;
        max-width: 220px;
        display: none;
        z-index: 1000;
      }
      #rotation-container {
        position: fixed;
        top: 12px;
        right: 12px;
        background: rgba(0,0,0,.6);
        padding: 6px 10px;
        border: 1px solid #555;
        border-radius: 6px;
        z-index: 1000;
        font-size: 14px;
        display: flex;
        align-items: center;
      }
      #status {
        font-size: 18px; /* bigger font */
        margin-top: 6px;
      }
    </style>
    <script src="https://unpkg.com/globe.gl"></script>
  </head>
  <body>
    <div id="globe"></div>
    <div id="tooltip"></div>
    
    <div id="rotation-container">
      <span style="margin-right:8px;">Auto Rotate</span>
      <label style="cursor:pointer;">
        <input type="checkbox" id="rotation-toggle" checked style="display:none;">
        <span id="toggle-slider" style="
          display:inline-block;width:40px;height:20px;
          background:#0f0;border-radius:10px;position:relative;vertical-align:middle;
          transition:background 0.3s;cursor:pointer;">
          <span style="
            position:absolute;top:2px;left:2px;width:16px;height:16px;
            background:white;border-radius:50%;transition:left 0.3s;"></span>
        </span>
      </label>
    </div>

    <div id="hud">
      <div><span class="dot" id="statusDot"></span><b>Live Threat Map</b></div>
      <div id="status">Connecting…</div>
    </div>

    <script>
      const world = Globe()
        (document.getElementById('globe'))
        .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-night.jpg')
        .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
        .backgroundColor('#000')
        .pointAltitude(0.0)
        .pointRadius(0.6)
        .pointColor(p => p.color)
        .pointsData([]);

      world.controls().autoRotate = true;
      world.controls().autoRotateSpeed = 0.5;
      world.pointLabel(() => '');

      const colors = ['#ff3b3b','#05ed19','#00c8ff','#ffcc00','#ff66ff','#ff9900'];
      const points = [];
      const tooltip = document.getElementById('tooltip');
      let lockedPoint = null;
      const rotationToggle = document.getElementById('rotation-toggle');
        const toggleSlider = document.getElementById('toggle-slider');

        rotationToggle.addEventListener('change', () => {
            const enabled = rotationToggle.checked;
            world.controls().autoRotate = enabled;

            // Animate slider knob
            const knob = toggleSlider.querySelector('span');
            if (enabled) {
            toggleSlider.style.background = '#0f0';
            knob.style.left = '2px';
            } else {
            toggleSlider.style.background = '#555';
            knob.style.left = '22px';
            }
        });

        // Initialize state on load
        rotationToggle.dispatchEvent(new Event('change'));

      world.onPointHover(point => {
        if (lockedPoint) return;
        showTooltip(point);
      });
      world.onPointClick(point => {
        lockedPoint = point;
        showTooltip(point);
      });
      function showTooltip(point) {
        if (!point) {
          if (!lockedPoint) tooltip.style.display = 'none';
          return;
        }
        tooltip.style.display = 'block';
        tooltip.innerHTML = `<b>${point.name}</b><br><i>${point.city}, ${point.country}</i>`;
      }
      document.addEventListener('click', ev => {
        if (!ev.target.closest('canvas')) {
          lockedPoint = null;
          tooltip.style.display = 'none';
        }
      });
      document.addEventListener('mousemove', ev => {
        if (!lockedPoint) {
          tooltip.style.top = `${ev.clientY + 12}px`;
          tooltip.style.left = `${ev.clientX + 12}px`;
        }
      });

      function addPoint(lat, lon, magnitude, label, city, country) {
        const color = colors[Math.floor(Math.random() * colors.length)];
        points.push({
          lat, lng: lon, alt: 0.05 + Math.random() * 0.1,
          name: label || 'event', color,
          city: city || 'Unknown city',
          country: country || 'Unknown country'
        });
        world.pointsData(points.slice(-2000));
      }

      const status = document.getElementById('status');
      const statusDot = document.getElementById('statusDot');
      const es = new EventSource('http://127.0.0.1:8000/events');
      es.onopen = () => {
        status.textContent = 'Streaming...';
        statusDot.style.background = '#05ed19';
      };
      es.onerror = () => {
        status.textContent = 'Disconnected (Retrying…)';
        statusDot.style.background = '#000';
      };
      es.onmessage = (msg) => {
        try {
          const ev = JSON.parse(msg.data);
          if (ev.lat && ev.lon) {
            addPoint(ev.lat, ev.lon, ev.metric, `${ev.kind.toUpperCase()} ${ev.score.toFixed(2)} ${ev.label||''}`, ev.city, ev.country);
          } else if (ev.country === "WW") {
            addPoint(0, 0, ev.metric, ev.label);
          }
        } catch (e) {
          console.warn("Failed to parse SSE event", e);
        }
      };
    </script>
  </body>
</html>
